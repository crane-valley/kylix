name: Release

on:
  release:
    types: [published]

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: read
  id-token: write

jobs:
  publish:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache
        uses: Swatinem/rust-cache@v2

      - name: Verify version matches tag
        run: |
          TAG_VERSION="${GITHUB_REF#refs/tags/v}"
          CARGO_VERSION=$(cargo metadata --no-deps --format-version 1 | \
            jq -r '.packages[] | select(.name == "kylix-pqc") | .version')
          if [ "$TAG_VERSION" != "$CARGO_VERSION" ]; then
            echo "Error: Tag version ($TAG_VERSION) does not match Cargo.toml version ($CARGO_VERSION)"
            exit 1
          fi
          echo "Version verified: $CARGO_VERSION"

      - name: Publish kylix-core
        run: |
          OUTPUT=$(cargo publish --package kylix-core --token ${{ secrets.CARGO_REGISTRY_TOKEN }} 2>&1) || {
            if echo "$OUTPUT" | grep -q "already exists on crates.io"; then
              echo "kylix-core already published, skipping"
            else
              echo "$OUTPUT"
              exit 1
            fi
          }

      - name: Wait for crates.io
        run: sleep 30

      - name: Publish kylix-ml-kem
        run: |
          OUTPUT=$(cargo publish --package kylix-ml-kem --token ${{ secrets.CARGO_REGISTRY_TOKEN }} 2>&1) || {
            if echo "$OUTPUT" | grep -q "already exists on crates.io"; then
              echo "kylix-ml-kem already published, skipping"
            else
              echo "$OUTPUT"
              exit 1
            fi
          }

      - name: Wait for crates.io
        run: sleep 30

      - name: Publish kylix-ml-dsa
        run: |
          OUTPUT=$(cargo publish --package kylix-ml-dsa --token ${{ secrets.CARGO_REGISTRY_TOKEN }} 2>&1) || {
            if echo "$OUTPUT" | grep -q "already exists on crates.io"; then
              echo "kylix-ml-dsa already published, skipping"
            else
              echo "$OUTPUT"
              exit 1
            fi
          }

      - name: Wait for crates.io
        run: sleep 30

      - name: Publish kylix-slh-dsa
        run: |
          OUTPUT=$(cargo publish --package kylix-slh-dsa --token ${{ secrets.CARGO_REGISTRY_TOKEN }} 2>&1) || {
            if echo "$OUTPUT" | grep -q "already exists on crates.io"; then
              echo "kylix-slh-dsa already published, skipping"
            else
              echo "$OUTPUT"
              exit 1
            fi
          }

      - name: Wait for crates.io
        run: sleep 30

      - name: Publish kylix-pqc
        run: |
          OUTPUT=$(cargo publish --package kylix-pqc --token ${{ secrets.CARGO_REGISTRY_TOKEN }} 2>&1) || {
            if echo "$OUTPUT" | grep -q "already exists on crates.io"; then
              echo "kylix-pqc already published, skipping"
            else
              echo "$OUTPUT"
              exit 1
            fi
          }
