name: Publish to crates.io

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 0.5.0)'
        required: true
        type: string
      dry_run:
        description: 'Dry run (skip actual publish)'
        required: false
        type: boolean
        default: false

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: read
  id-token: write

jobs:
  publish:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache
        uses: Swatinem/rust-cache@v2

      - name: Verify version
        run: |
          # Get version from input or tag
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            EXPECTED_VERSION="${{ inputs.version }}"
          else
            EXPECTED_VERSION="${GITHUB_REF#refs/tags/v}"
          fi

          CARGO_VERSION=$(cargo metadata --no-deps --format-version 1 | \
            jq -r '.packages[] | select(.name == "kylix-pqc") | .version')

          if [ "$EXPECTED_VERSION" != "$CARGO_VERSION" ]; then
            echo "Error: Expected version ($EXPECTED_VERSION) does not match Cargo.toml version ($CARGO_VERSION)"
            exit 1
          fi
          echo "Version verified: $CARGO_VERSION"

          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "DRY_RUN=--dry-run" >> $GITHUB_ENV
            echo "Dry run mode enabled"
          else
            echo "DRY_RUN=" >> $GITHUB_ENV
          fi

      - name: Publish kylix-core
        run: |
          OUTPUT=$(cargo publish --package kylix-core --token ${{ secrets.CARGO_REGISTRY_TOKEN }} $DRY_RUN 2>&1) || {
            if echo "$OUTPUT" | grep -q "already exists on crates.io"; then
              echo "kylix-core already published, skipping"
            else
              echo "$OUTPUT"
              exit 1
            fi
          }

      - name: Wait for crates.io
        run: sleep 30

      - name: Publish kylix-ml-kem
        run: |
          OUTPUT=$(cargo publish --package kylix-ml-kem --token ${{ secrets.CARGO_REGISTRY_TOKEN }} $DRY_RUN 2>&1) || {
            if echo "$OUTPUT" | grep -q "already exists on crates.io"; then
              echo "kylix-ml-kem already published, skipping"
            else
              echo "$OUTPUT"
              exit 1
            fi
          }

      - name: Wait for crates.io
        run: sleep 30

      - name: Publish kylix-ml-dsa
        run: |
          OUTPUT=$(cargo publish --package kylix-ml-dsa --token ${{ secrets.CARGO_REGISTRY_TOKEN }} $DRY_RUN 2>&1) || {
            if echo "$OUTPUT" | grep -q "already exists on crates.io"; then
              echo "kylix-ml-dsa already published, skipping"
            else
              echo "$OUTPUT"
              exit 1
            fi
          }

      - name: Wait for crates.io
        run: sleep 30

      - name: Publish kylix-slh-dsa
        run: |
          OUTPUT=$(cargo publish --package kylix-slh-dsa --token ${{ secrets.CARGO_REGISTRY_TOKEN }} $DRY_RUN 2>&1) || {
            if echo "$OUTPUT" | grep -q "already exists on crates.io"; then
              echo "kylix-slh-dsa already published, skipping"
            else
              echo "$OUTPUT"
              exit 1
            fi
          }

      - name: Wait for crates.io
        run: sleep 30

      - name: Publish kylix-pqc
        run: |
          OUTPUT=$(cargo publish --package kylix-pqc --token ${{ secrets.CARGO_REGISTRY_TOKEN }} $DRY_RUN 2>&1) || {
            if echo "$OUTPUT" | grep -q "already exists on crates.io"; then
              echo "kylix-pqc already published, skipping"
            else
              echo "$OUTPUT"
              exit 1
            fi
          }
